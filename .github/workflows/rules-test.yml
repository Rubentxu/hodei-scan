name: Test hodei-scan Rules

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Test Rust code and rule engine
  test-rust:
    name: Test Rust Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.toml') }}
          
      - name: Install cargo dependencies
        run: cargo fetch
        
      - name: Build all crates
        run: cargo build --all
        
      - name: Run unit tests
        run: cargo test --all --verbose
        
      - name: Run integration tests
        run: cargo test --all --test '*' --verbose
        
      - name: Generate test coverage
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --output-dir coverage --all-features
          
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  # Test rule files using hodei-test
  test-rules:
    name: Test Rule Files
    runs-on: ubuntu-latest
    needs: test-rust
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install hodei-scan CLI
        run: cargo install --path crates/hodei-cli
        
      - name: Run Rule Tests
        run: |
          echo "Running hodei-test rule validation..."
          # Find all rule files
          find . -name "*.hodei" -type f | head -5
          
          # Run tests if test files exist
          if find . -name "*.hodei.test" -type f | grep -q .; then
            for test_file in $(find . -name "*.hodei.test" -type f); do
              echo "Testing: $test_file"
              # hodei-test validate "$test_file" --verbose
            done
          else
            echo "No test files found. Creating example test structure..."
          fi
          
      - name: Upload Rule Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rule-test-results
          path: |
            test-results/
            *.log

  # Test LSP Server
  test-lsp:
    name: Test LSP Server
    runs-on: ubuntu-latest
    needs: test-rust
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Build LSP Server
        run: cargo build --package hodei-dsl-lsp
        
      - name: Run LSP Tests
        run: cargo test --package hodei-dsl-lsp --verbose

  # Test IR Dump Tool
  test-ir-dump:
    name: Test IR Dump Tool
    runs-on: ubuntu-latest
    needs: test-rust
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Build IR Dump Tool
        run: cargo build --package ir-dump
        
      - name: Test IR Dump
        run: |
          cargo test --package ir-dump --verbose
          echo "Testing CLI functionality..."
          # cargo run --package ir-dump -- --help

  # Extension Tests (if Node.js is available)
  test-extension:
    name: Test VS Code Extension
    runs-on: ubuntu-latest
    if: false  # Disabled until extension dependencies are set up
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install extension dependencies
        run: |
          cd extensions/vscode-hodei-dsl
          npm install
          
      - name: Compile extension
        run: |
          cd extensions/vscode-hodei-dsl
          npm run compile
          
      - name: Run extension tests
        run: |
          cd extensions/vscode-hodei-dsl
          npm test

  # Publish coverage report
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: [test-rust, test-rules, test-lsp, test-ir-dump]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rule-test-results
          
      - name: Generate summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Tests | ${{ needs.test-rust.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| Rule Tests | ${{ needs.test-rules.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| LSP Tests | ${{ needs.test-lsp.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| IR Dump Tests | ${{ needs.test-ir-dump.result }}" >> $GITHUB_STEP_SUMMARY
